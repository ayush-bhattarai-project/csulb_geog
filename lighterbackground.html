<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Map with Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100%; }
        #chart-box {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 400px;
            height: 350px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #chart {
            width: 100%;
            height: 250px;
        }
        #refresh-link {
            position: absolute;
            top: 10px; /* Position at the top */
            right: 10px; /* Align to the right */
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        #refresh-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="chart-box">
        <a id="refresh-link" href="#">Refresh</a>
        <canvas id="chart"></canvas>
    </div>
    <script>
        // Initialize the map
        var map = L.map('map').setView([33.782045605168058, -118.121328502290766], 14);

        // Add a lighter basemap (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Define a list of custom colors for the lines
        const lineColors = ['#1b9e77', '#d95f02', '#7570b3', '#e7298a', '#66a61e', '#e6ab02', '#a6761d', '#666666'];
        let colorIndex = 0; // To cycle through the colors

        // Fetch the external GeoJSON file
        fetch('roadlines.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    onEachFeature: function(feature, layer) {
                        // Bind popup to each feature
                        layer.bindPopup(`<b>${feature.properties.Name}</b><br>Direction: ${feature.properties.Direction}`);
                        // Attach click event to update the chart
                        layer.on('click', function(e) {
                            addToChart(feature.properties);
                        });
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));

        // Initialize the Chart.js chart
        var ctx = document.getElementById('chart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true, // Use line instead of rectangle in the legend
                            pointStyle: 'line'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Daily Traffic Volume',
                        font: { size: 18, weight: 'bold' },
                        align: 'center'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Function to add a new dataset to the chart
        function addToChart(properties) {
            const existingDatasetIndex = chart.data.datasets.findIndex(dataset => dataset.label === properties.Name);

            // If the dataset already exists, return (no duplicate lines)
            if (existingDatasetIndex !== -1) return;

            // Prepare the dataset
            const newDataset = {
                label: properties.Name,
                data: [
                    properties.Monday,
                    properties.Tuesday,
                    properties.Wednesday,
                    properties.Thursday,
                    properties.Friday,
                    properties.Saturday,
                    properties.Sunday
                ],
                backgroundColor: 'rgba(0,0,0,0)', // No background fill
                borderColor: lineColors[colorIndex % lineColors.length], // Assign color from the custom list
                borderWidth: 2,
                tension: 0.4,
                fill: false
            };

            // Increment the color index
            colorIndex++;

            // Add the new dataset to the chart
            chart.data.datasets.push(newDataset);

            // Update the chart
            chart.update();
        }

        // Refresh link functionality
        document.getElementById('refresh-link').addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            // Clear all datasets
            chart.data.datasets = [];
            chart.update();
            colorIndex = 0; // Reset the color index
        });
    </script>
</body>
</html>